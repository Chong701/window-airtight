<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°”å¯†æ€§ AI ä¸“å®¶åˆ†æç³»ç»Ÿ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #0f172a; }
        body { font-family: system-ui, sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
        .container { max-width: 800px; margin: auto; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 20px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

        .upload-box { border: 2px dashed #cbd5e1; background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; }
        .btn { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        
        /* å†å²è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8fafc; color: #64748b; }

        /* å¼¹çª—æŠ¥å‘Š */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; }
        .report-box { background:white; width:90%; max-width:500px; padding:40px; border-radius:15px; position:relative; }
        .report-header { border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        
        #encodingFix { display:none; background:#fffbeb; padding:10px; border-radius:8px; font-size:0.8rem; margin:10px 0; cursor:pointer; text-decoration:underline; }
    </style>
</head>
<body>

<div class="container">
    <div class="card header" style="text-align: center;">
        <h1 style="margin:0">ğŸ  æ°”å¯†æ€§ AI ä¸“å®¶ç³»ç»Ÿ Pro</h1>
        <p style="color: #64748b;">å¤§æ•°æ®å»ºæ¨¡ Â· æ™ºèƒ½é¢„æµ‹ Â· è‡ªåŠ¨æŠ¥å‘Š</p>
    </div>

    <div class="grid">
        <div class="card">
            <div class="upload-box" onclick="document.getElementById('fileIn').click()">
                <div id="status">ç‚¹å‡»å¯¼å…¥å†å² CSV æ•°æ®</div>
                <input type="file" id="fileIn" accept=".csv" style="display:none">
            </div>
            <div id="encodingFix" onclick="reloadWithEncoding('GBK')">âš ï¸ ä¸­æ–‡ä¹±ç ï¼Ÿå°è¯• GBK é‡æ–°åŠ è½½</div>
            
            <div id="dynamicForm" style="display:none; margin-top:20px;">
                <div id="inputsContainer"></div>
                <button class="btn" onclick="predict()">æ‰§è¡Œæ™ºèƒ½é¢„æµ‹</button>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0; font-size:1rem;">å†å²æ•°æ®åˆ†å¸ƒå›¾</h3>
            <canvas id="dataChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-top:0">ğŸ“‘ é¢„æµ‹å†å²å­˜è¯</h3>
        <div style="overflow-x: auto;">
            <table id="historyTable">
                <thead><tr id="tableHeader"><th>æ—¶é—´</th><th>ç»“æœ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="reportModal" class="modal">
    <div class="report-box" id="printableReport">
        <div class="report-header">
            <h2>æ£€æµ‹æŠ¥å‘Šå•</h2>
            <small>REPORT OF AIRTIGHTNESS PREDICTION</small>
        </div>
        <div id="reportContent" style="line-height: 2;"></div>
        <div style="margin-top:30px; border-top:1px solid #eee; padding-top:10px; font-size:0.8rem; color:#94a3b8;">
            * æœ¬æŠ¥å‘ŠåŸºäºå¤§æ•°æ®ç›¸ä¼¼åº¦ç®—æ³•ç”Ÿæˆï¼Œä»…ä¾›å·¥ç¨‹å‚è€ƒã€‚
        </div>
        <button class="btn" onclick="window.print()" style="background:#0f172a">æ‰“å° / å¯¼å‡º PDF</button>
        <button class="btn" style="background:#eee; color:#334155" onclick="closeModal()">å…³é—­</button>
    </div>
</div>

<script>
    let headers = [], csvRows = [], currentFile = null, chart = null;

    // --- æ–‡ä»¶è¯»å– ---
    document.getElementById('fileIn').addEventListener('change', e => {
        currentFile = e.target.files[0];
        reloadWithEncoding('UTF-8');
    });

    function reloadWithEncoding(enc) {
        const reader = new FileReader();
        reader.onload = e => {
            const text = e.target.result;
            if (text.includes('') && enc === 'UTF-8') { reloadWithEncoding('GBK'); return; }
            processCSV(text);
            document.getElementById('encodingFix').style.display = (enc === 'UTF-8') ? 'block' : 'none';
        };
        reader.readAsText(currentFile, enc);
    }

    function processCSV(text) {
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
        headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
        csvRows = lines.slice(1).map(r => r.split(',').map(v => v.trim()));
        
        initChart(); // åˆå§‹åŒ–å›¾è¡¨
        generateForm(); // ç”Ÿæˆè¡¨å•
    }

    // --- åŠŸèƒ½ Bï¼šæ•°æ®å¯è§†åŒ– ---
    function initChart() {
        const ctx = document.getElementById('dataChart').getContext('2d');
        if (chart) chart.destroy();
        
        // æå– ç¼é•¿(x) å’Œ ç»“æœ(y)
        const chartData = csvRows.map(r => ({ x: parseFloat(r[1]), y: parseFloat(r[r.length-1]) }));
        
        chart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'å†å²æ•°æ®åˆ†å¸ƒ',
                    data: chartData,
                    backgroundColor: '#2563eb'
                }]
            },
            options: {
                scales: { 
                    x: { title: { display: true, text: 'ç¼é•¿ (mm)' } },
                    y: { title: { display: true, text: 'æ¸—é€é‡' } }
                }
            }
        });
    }

    // --- ç”Ÿæˆè¡¨å• ---
    function generateForm() {
        const container = document.getElementById('inputsContainer');
        container.innerHTML = '';
        for (let i = 1; i < headers.length - 1; i++) {
            container.innerHTML += `<div style="margin-bottom:10px">
                <label style="font-size:0.8rem; font-weight:bold">${headers[i]}</label>
                <input type="number" class="dynamic-input" data-idx="${i}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
            </div>`;
        }
        document.getElementById('dynamicForm').style.display = 'block';
        document.getElementById('status').innerText = "âœ… æ•°æ®å»ºæ¨¡å·²å®Œæˆ";

        // æ›´æ–°å†å²è¡¨æ ¼è¡¨å¤´
        const headRow = document.getElementById('tableHeader');
        headRow.innerHTML = '<th>æ—¶é—´</th>' + headers.slice(1, -1).map(h => `<th>${h}</th>`).join('') + `<th>é¢„æµ‹ç»“æœ</th>`;
    }

    // --- åŠŸèƒ½ A & Cï¼šé¢„æµ‹ä¸æŠ¥å‘Š ---
    function predict() {
        const inputs = document.getElementsByClassName('dynamic-input');
        let userInputs = {}, paramsText = "";
        
        for (let input of inputs) {
            const idx = input.getAttribute('data-idx');
            const val = parseFloat(input.value);
            if (isNaN(val)) return alert("è¯·å®Œæ•´å¡«å†™");
            userInputs[idx] = val;
            paramsText += `<p><b>${headers[idx]}ï¼š</b>${val}</p>`;
        }

        // ç®—æ³•è®¡ç®—
        let totalW = 0, totalS = 0;
        csvRows.forEach(row => {
            let d = 0;
            for (let idx in userInputs) d += Math.pow((row[idx] - userInputs[idx]) / userInputs[idx], 2);
            let sim = 1 / (Math.sqrt(d) + 0.001);
            totalW += row[row.length - 1] * sim;
            totalS += sim;
        });

        const result = (totalW / totalS).toFixed(4);

        // ä¿å­˜åˆ°å†å²è®°å½•è¡¨æ ¼
        const now = new Date().toLocaleTimeString();
        let rowHtml = `<tr><td>${now}</td>`;
        for (let idx in userInputs) rowHtml += `<td>${userInputs[idx]}</td>`;
        rowHtml += `<td style="color:var(--primary); font-weight:bold">${result}</td></tr>`;
        document.querySelector('#historyTable tbody').insertAdjacentHTML('afterbegin', rowHtml);

        // ç”ŸæˆæŠ¥å‘Šå†…å®¹
        document.getElementById('reportContent').innerHTML = `
            ${paramsText}
            <div style="background:#f8fafc; padding:20px; border-radius:10px; margin-top:20px; text-align:center">
                <span style="font-size:1rem; color:#64748b">AI é¢„æµ‹ç»“æœ (${headers[headers.length-1]})</span>
                <div style="font-size:3rem; font-weight:bold; color:var(--primary)">${result}</div>
            </div>
        `;
        document.getElementById('reportModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('reportModal').style.display = 'none'; }
</script>

</body>
</html>
