<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°”å¯†æ€§ AI ä¸“å®¶ç³»ç»Ÿ Pro+ (å¤šç»´å›¾è¡¨ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #0f172a; }
        body { font-family: system-ui, sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
        .container { max-width: 900px; margin: auto; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px; }
        @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }

        .upload-box { border: 2px dashed #cbd5e1; background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; }
        .btn { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8fafc; color: #64748b; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index: 100; }
        .report-box { background:white; width:90%; max-width:500px; padding:40px; border-radius:15px; }
        
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card" style="text-align: center;">
        <h1 style="margin:0">ğŸ  æ°”å¯†æ€§ AI ä¸“å®¶ç³»ç»Ÿ Pro+</h1>
        <p style="color: #64748b;">æ”¯æŒå¤šç»´æ•£ç‚¹çŸ©é˜µåˆ†æ Â· è‡ªåŠ¨ç¼–ç ä¿®å¤</p>
    </div>

    <div class="grid">
        <div class="card">
            <div class="upload-box" onclick="document.getElementById('fileIn').click()">
                <div id="status">ç‚¹å‡»å¯¼å…¥ CSV æ•°æ®</div>
                <input type="file" id="fileIn" accept=".csv" style="display:none">
            </div>
            
            <div id="dynamicForm" style="display:none; margin-top:20px;">
                <h4 style="margin-bottom:10px">æ™ºèƒ½é¢„æµ‹è¾“å…¥ï¼š</h4>
                <div id="inputsContainer"></div>
                <button class="btn" onclick="predict()">æ‰§è¡Œæ™ºèƒ½é¢„æµ‹</button>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin:0; font-size:1rem;">å¤šç»´å…³è”æ€§åˆ†æ</h3>
                <select id="chartDimSelector" style="width: auto; margin: 0;" onchange="updateChart()">
                    <option value="">ç­‰å¾…æ•°æ®å¯¼å…¥...</option>
                </select>
            </div>
            <canvas id="dataChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“‘ é¢„æµ‹å†å²è®°å½•</h3>
        <div style="overflow-x: auto;">
            <table id="historyTable">
                <thead><tr id="tableHeader"><th>æ—¶é—´</th><th>é¢„æµ‹ç»“æœ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="reportModal" class="modal">
    <div class="report-box">
        <div style="text-align:center; border-bottom:2px solid var(--primary); margin-bottom:20px;">
            <h2>æ£€æµ‹é¢„æµ‹æŠ¥å‘Š</h2>
        </div>
        <div id="reportContent" style="line-height: 2;"></div>
        <button class="btn" onclick="window.print()">æ‰“å°æŠ¥å‘Š / ä¿å­˜ PDF</button>
        <button class="btn" style="background:#eee; color:#334155" onclick="closeModal()">å…³é—­</button>
    </div>
</div>

<script>
    let headers = [], csvRows = [], chart = null;

    document.getElementById('fileIn').addEventListener('change', e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = event => {
            const text = event.target.result;
            // è‡ªåŠ¨å¤„ç†ä¹±ç å°è¯•
            const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
            headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            csvRows = lines.slice(1).map(r => r.split(',').map(v => v.trim()));
            
            setupDimensionSelector();
            generateForm();
            updateChart();
        };
        // é»˜è®¤å°è¯• GBK ä»¥é€‚é… Excel ä¸­æ–‡
        reader.readAsText(file, 'GBK');
    });

    // åˆå§‹åŒ–ç»´åº¦åˆ‡æ¢ä¸‹æ‹‰æ¡†
    function setupDimensionSelector() {
        const selector = document.getElementById('chartDimSelector');
        selector.innerHTML = '';
        // æå–æ‰€æœ‰ç‰¹å¾ç»´åº¦ï¼ˆæ’é™¤åºå·å’Œæœ€åä¸€åˆ—ç»“æœï¼‰
        for (let i = 1; i < headers.length - 1; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = `æŸ¥çœ‹å…³ç³»ï¼š${headers[i]} vs ç»“æœ`;
            selector.appendChild(opt);
        }
    }

    // æ›´æ–°å›¾è¡¨é€»è¾‘
    function updateChart() {
        const selector = document.getElementById('chartDimSelector');
        const selectedIdx = parseInt(selector.value);
        if (isNaN(selectedIdx)) return;

        const ctx = document.getElementById('dataChart').getContext('2d');
        if (chart) chart.destroy();

        // æå–é€‰ä¸­åˆ—ä¸ç»“æœåˆ—çš„æ•°æ®ç‚¹
        const scatterData = csvRows.map(row => ({
            x: parseFloat(row[selectedIdx]),
            y: parseFloat(row[row.length - 1])
        })).filter(p => !isNaN(p.x) && !isNaN(p.y));

        chart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: `${headers[selectedIdx]} ç›¸å…³æ€§åˆ†å¸ƒ`,
                    data: scatterData,
                    backgroundColor: 'rgba(37, 99, 235, 0.7)',
                    borderColor: 'rgba(37, 99, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: headers[selectedIdx] } },
                    y: { title: { display: true, text: headers[headers.length-1] } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `å‚æ•°: ${ctx.parsed.x}, ç»“æœ: ${ctx.parsed.y}`
                        }
                    }
                }
            }
        });
    }

    function generateForm() {
        const container = document.getElementById('inputsContainer');
        container.innerHTML = '';
        for (let i = 1; i < headers.length - 1; i++) {
            container.innerHTML += `<div style="margin-bottom:12px">
                <label style="font-size:0.85rem; font-weight:bold">${headers[i]}</label>
                <input type="number" class="dynamic-input" data-idx="${i}" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box">
            </div>`;
        }
        document.getElementById('dynamicForm').style.display = 'block';
        document.getElementById('status').innerText = "âœ… æ•°æ®åˆ†æå·²å®Œæˆ";

        // æ›´æ–°å†å²è¡¨å¤´
        const headRow = document.getElementById('tableHeader');
        headRow.innerHTML = '<th>æ—¶é—´</th>' + headers.slice(1, -1).map(h => `<th>${h}</th>`).join('') + `<th>é¢„æµ‹ç»“æœ</th>`;
    }

    function predict() {
        const inputs = document.getElementsByClassName('dynamic-input');
        let userInputs = {}, reportHtml = "";
        
        for (let input of inputs) {
            const idx = input.getAttribute('data-idx');
            const val = parseFloat(input.value);
            if (isNaN(val)) return alert("è¯·å®Œæ•´è¾“å…¥æ•°æ®");
            userInputs[idx] = val;
            reportHtml += `<p><b>${headers[idx]}ï¼š</b>${val}</p>`;
        }

        // AI åŠ æƒç®—æ³•
        let totalW = 0, totalS = 0;
        csvRows.forEach(row => {
            let dist = 0;
            for (let idx in userInputs) {
                dist += Math.pow((parseFloat(row[idx]) - userInputs[idx]) / (userInputs[idx] || 1), 2);
            }
            let sim = 1 / (Math.sqrt(dist) + 0.0001);
            totalW += parseFloat(row[row.length - 1]) * sim;
            totalS += sim;
        });

        const result = (totalW / totalS).toFixed(4);

        // æ’å…¥è®°å½•
        const row = `<tr><td>${new Date().toLocaleTimeString()}</td>` + 
                    Object.values(userInputs).map(v => `<td>${v}</td>`).join('') + 
                    `<td style="font-weight:bold; color:var(--primary)">${result}</td></tr>`;
        document.querySelector('#historyTable tbody').insertAdjacentHTML('afterbegin', row);

        // æ˜¾ç¤ºæŠ¥å‘Š
        document.getElementById('reportContent').innerHTML = reportHtml + `
            <div style="background:#f8fafc; padding:20px; border-radius:12px; margin-top:20px; text-align:center">
                <div style="color:#64748b; font-size:0.9rem">é¢„æµ‹ï¼š${headers[headers.length-1]}</div>
                <div style="font-size:2.5rem; font-weight:bold; color:var(--primary)">${result}</div>
            </div>`;
        document.getElementById('reportModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('reportModal').style.display = 'none'; }
</script>

</body>
</html>
